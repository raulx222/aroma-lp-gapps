ui_print(" ");
ui_print("LP-GAPPS");                          
ui_print("AROMA");
ui_print(" ");

set_progress(0.1);
ui_print("-> Mounting system...");
run_program("/sbin/busybox", "mount", "/system");

set_progress(0.3);
ui_print(" ");

ui_print("-> Removing old GApps...");

delete_recursive(
"system/app/CalendarGoogle",
"system/app/Chrome",
"system/app/ConfigUpdater",
"system/app/Drive",
"system/app/ExchangeServices",
"system/app/FaceLock",
"system/app/GenieWidget",
"system/app/Gmail2",
"system/app/GoogleCalendarSyncAdapter",
"system/app/GoogleContactsSyncAdapter",
"system/app/GoogleHome",
"system/app/GoogleTTS",
"system/app/Hangouts",
"system/app/HangoutsDialer",
"system/app/Keep",
"system/app/Keyboard",
"system/app/Maps",
"system/app/Messenger",
"system/app/Music2",
"system/app/PlusOne",
"system/app/Street",
"system/app/Translate",
"system/app/Wallet",
"system/app/YouTube",
"system/etc/g.prop",
"system/etc/permissions/com.google.android.camera2.xml",
"system/etc/permissions/com.google.android.dialer.support.xml",
"system/etc/permissions/com.google.android.maps.xml",
"system/etc/permissions/com.google.android.media.effects.xml",
"system/etc/permissions/com.google.widevine.software.drm.xml",
"system/etc/permissions/features.xml",
"system/etc/preferred-apps/google.xml",
"system/framework/com.google.android.camera2.jar",
"system/framework/com.google.android.dialer.support.jar",
"system/framework/com.google.android.maps.jar",
"system/framework/com.google.android.media.effects.jar",
"system/framework/com.google.widevine.software.drm.jar",
"system/lib/libfilterpack_facedetect.so",
"system/lib/libjni_latinime.so",
"system/lib/libjni_latinimegoogle.so",
"system/priv-app/GoogleBackupTransport",
"system/priv-app/GoogleFeedback",
"system/priv-app/GoogleLoginService",
"system/priv-app/GoogleOneTimeInitializer",
"system/priv-app/GooglePartnerSetup",
"system/priv-app/GoogleServicesFramework",
"system/priv-app/Phonesky",
"system/priv-app/PrebuiltGmsCore",
"system/priv-app/SetupWizard",
"system/priv-app/Velvet",
"system/tts",
"/system/usr/srec/en-US/c_fst",
"/system/usr/srec/en-US/clg",
"/system/usr/srec/en-US/commands.abnf",
"/system/usr/srec/en-US/compile_grammar.config",
"/system/usr/srec/en-US/contacts.abnf",
"/system/usr/srec/en-US/dict",
"/system/usr/srec/en-US/dictation.config",
"/system/usr/srec/en-US/dnn",
"/system/usr/srec/en-US/endpointer_dictation.config",
"/system/usr/srec/en-US/endpointer_voicesearch.config",
"/system/usr/srec/en-US/ep_acoustic_model",
"/system/usr/srec/en-US/g2p_fst",
"/system/usr/srec/en-US/grammar.config",
"/system/usr/srec/en-US/hclg_shotword",
"/system/usr/srec/en-US/hmm_symbols",
"/system/usr/srec/en-US/hmmlist",
"/system/usr/srec/en-US/hotword.config",
"/system/usr/srec/en-US/hotword_classifier",
"/system/usr/srec/en-US/hotword_normalizer",
"/system/usr/srec/en-US/hotword_prompt.txt",
"/system/usr/srec/en-US/hotword_word_symbols",
"/system/usr/srec/en-US/metadata",
"/system/usr/srec/en-US/norm_fst",
"/system/usr/srec/en-US/normalizer",
"/system/usr/srec/en-US/offensive_word_normalizer",
"/system/usr/srec/en-US/phone_state_map",
"/system/usr/srec/en-US/phonelist",
"/system/usr/srec/en-US/rescoring_lm",
"/system/usr/srec/en-US/wordlist",
"/system/vendor/pittpatt/models/detection/multi_pose_face_landmark_detectors.8/landmark_group_meta_data.bin",
"/system/vendor/pittpatt/models/detection/multi_pose_face_landmark_detectors.8/left_eye-y0-yi45-p0-pi45-r0-ri20.lg_32-tree7-wmd.bin",
"/system/vendor/pittpatt/models/detection/multi_pose_face_landmark_detectors.8/nose_base-y0-yi45-p0-pi45-r0-ri20.lg_32-tree7-wmd.bin",
"/system/vendor/pittpatt/models/detection/multi_pose_face_landmark_detectors.8/right_eye-y0-yi45-p0-pi45-r0-ri20.lg_32-3-tree7-wmd.bin",
"/system/vendor/pittpatt/models/detection/yaw_roll_face_detectors.7.1/head-y0-yi45-p0-pi45-r0-ri30.4a-v24-tree7-2-wmd.bin",
"/system/vendor/pittpatt/models/detection/yaw_roll_face_detectors.7.1/head-y0-yi45-p0-pi45-rn30-ri30.5-v24-tree7-2-wmd.bin",
"/system/vendor/pittpatt/models/detection/yaw_roll_face_detectors.7.1/head-y0-yi45-p0-pi45-rp30-ri30.5-v24-tree7-2-wmd.bin",
"/system/vendor/pittpatt/models/detection/yaw_roll_face_detectors.7.1/pose-r.8.1.bin",
"/system/vendor/pittpatt/models/detection/yaw_roll_face_detectors.7.1/pose-y-r.8.1.bin",
"/system/vendor/pittpatt/models/recognition/face.face.y0-y0-71-N-tree_7-wmd.bin"
);

#-----Stock AOSP replace
if
	file_getprop("/tmp/aroma/gapps.prop", "item.3.1") == "1"
then
	ui_print("-> Removing some stock apps...");
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.1") == "1"
	then
		ui_print("	-> Removing stock app: Browser");
		delete_recursive("/system/app/Browser");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.7") == "1"
	then
		ui_print("	-> Removing stock app: MMS");
		delete_recursive("/system/priv-app/Mms");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.10") == "1"
	then
		ui_print("	-> Removing stock app: PicoTTS");
		delete_recursive("/system/app/PicoTts", "/system/priv-app/PicoTts", "/system/lib/libttscompat.so", "/system/lib/libttspico.so");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.14") == "1"
	then
		ui_print("	-> Removing stock app: Calendar");
		delete_recursive("/system/app/Calendar" , "/system/priv-app/Calendar");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.11") == "1"
	then
		ui_print("	-> Removing stock app: Keyboard");
		delete_recursive("/system/app/LatinIME");
	endif;
endif;


ui_print("-> Installing GApps...");

if
	file_getprop("/tmp/aroma/gapps.prop", "item.2.1") == "1"
then

	ui_print("	-> Installing core apps and all optional apps...");
	package_extract_dir("system", "/system");
	ui_print("-> Installing FaceUnlock and/or optional apps...");
	package_extract_dir("optional", "/tmp");
	package_extract_file("install-optional.sh", "/tmp/install-optional.sh");
	set_perm(0, 0, 0777, "/tmp/install-optional.sh");
	run_program("/tmp/install-optional.sh", "");
	
	set_progress(0.7);

else
	#-----CORE APPS
	ui_print("	-> Installing core apps...");
	package_extract_dir("system/app/ConfigUpdater", "/system/app/ConfigUpdater");
	package_extract_dir("system/app/ExchangeServices", "/system/app/ExchangeServices");
	package_extract_dir("system/app/GoogleCalendarSyncAdapter", "/system/app/GoogleCalendarSyncAdapter");
	package_extract_dir("system/app/GoogleContactsSyncAdapter", "/system/app/GoogleContactsSyncAdapter");
	package_extract_dir("system/etc", "/system/etc");
	package_extract_dir("system/framework", "/system/framework");
	package_extract_dir("system/lib", "/system/lib");
	package_extract_dir("system/priv-app/GoogleBackupTransport", "/system/priv-app/GoogleBackupTransport");
	package_extract_dir("system/priv-app/GoogleFeedback", "/system/priv-app/GoogleFeedback");
	package_extract_dir("system/priv-app/GoogleLoginService", "/system/priv-app/GoogleLoginService");
	package_extract_dir("system/priv-app/GoogleOneTimeInitializer", "/system/priv-app/GoogleOneTimeInitializer");
	package_extract_dir("system/priv-app/GooglePartnerSetup", "/system/priv-app/GooglePartnerSetup");
	package_extract_dir("system/priv-app/GoogleServicesFramework", "/system/priv-app/GoogleServicesFramework");
	package_extract_dir("system/priv-app/Phonesky", "/system/priv-app/Phonesky");
	package_extract_dir("system/priv-app/PrebuiltGmsCore", "/system/priv-app/PrebuiltGmsCore");
	package_extract_dir("system/priv-app/SetupWizard", "/system/priv-app/SetupWizard");
	
	set_progress(0.5);
	#-----OPTIONAL APPS
	ui_print("	-> Installing selected apps(if selected)...");
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.1") == "1"
	then
		package_extract_dir("system/app/YouTube", "/system/app/YouTube");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.2") == "1"
	then
		package_extract_dir("system/app/Chrome", "/system/app/Chrome");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.3") == "1"
	then
		package_extract_dir("system/app/Gmail2", "/system/app/Gmail2");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.4") == "1"
	then
		package_extract_dir("system/app/Hangouts", "/system/app/Hangouts");
		package_extract_dir("system/app/HangoutsDialer", "/system/app/HangoutsDialer");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.5") == "1"
	then
		package_extract_dir("system/priv-app/talkback", "/system/priv-app/talkback");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.7") == "1"
	then
		package_extract_dir("system/app/Messenger", "/system/app/Messenger");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.8") == "1"
	then
		package_extract_dir("system/app/GenieWidget", "/system/app/GenieWidget");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.9") == "1"
	then
		package_extract_dir("system/app/GoogleHome", "/system/app/GoogleHome");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.10") == "1"
	then
		package_extract_dir("system/app/GoogleTTS", "/system/app/GoogleTTS");
		package_extract_dir("system/tts", "/system/tts");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.11") == "1"
	then
		package_extract_dir("system/app/Keyboard", "/system/app/Keyboard");
		package_extract_dir("system/usr/srec/en-US", "/system/usr/srec/en-US");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.12") == "1"
	then
		package_extract_dir("system/app/Music2", "/system/app/Music2");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.13") == "1"
	then
		package_extract_dir("system/priv-app/Velvet", "/system/priv-app/Velvet");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.14") == "1"
	then
		package_extract_dir("system/app/CalendarGoogle", "/system/app/CalendarGoogle");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.15") == "1"
	then
		package_extract_dir("system/app/Drive", "/system/app/Drive");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.16") == "1"
	then
		package_extract_dir("system/app/Keep", "/system/app/Keep");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.17") == "1"
	then
		package_extract_dir("system/app/Maps", "/system/app/Maps");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.18") == "1"
	then
		package_extract_dir("system/app/PlusOne", "/system/app/PlusOne");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.19") == "1"
	then
		package_extract_dir("system/app/Street", "/system/app/Street");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.20") == "1"
	then
		package_extract_dir("system/app/Translate", "/system/app/Translate");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.21") == "1"
	then
		package_extract_dir("system/app/Wallet", "/system/app/Wallet");
	endif;
	if
		file_getprop("/tmp/aroma/gapps.prop", "item.1.6") == "1"
	then
		ui_print("-> Installing FaceUnlock and/or optional apps...");
		package_extract_dir("optional", "/tmp");
		package_extract_file("install-optional.sh", "/tmp/install-optional.sh");
		set_perm(0, 0, 0777, "/tmp/install-optional.sh");
		run_program("/tmp/install-optional.sh", "");
	endif;
	set_progress(0.8);
endif;

#-------Flash backup script
delete("/system/addon.d/82-full_gapps.sh","/system/addon.d/81-normal_gapps.sh","/system/addon.d/80-gapps.sh");
ui_print("-> Flashing backup script...");
if
	file_getprop("/tmp/aroma/gapps.prop", "item.3.1") == "1"
then
	package_extract_file("system/addon.d/80-gapps_rmstockapps.sh", "/system/addon.d/80-gapps.sh");
else
	package_extract_file("system/addon.d/80-gapps.sh", "/system/addon.d/80-gapps.sh");
endif;
set_perm(0, 0, 0755, "/system/addon.d/80-gapps.sh");


#----------Protection script
#Check if "Install all" is selected. If not, execute the protection script.
if
	file_getprop("/tmp/aroma/gapps.prop", "item.2.1") == "0"
then
	ui_print("-> Execute protection script...");
	package_extract_file("protection.sh", "/tmp/protection.sh");
	set_perm(0, 0, 0777, "/tmp/protection.sh");
	run_program("/tmp/protection.sh", "");

#Check if at least one app from a certain type is installed. If not, force install the Google app counterpart.
if
	file_getprop("/tmp/aroma/gapps.prop", "item.1.2") == "0"
then
	if
		file_getprop("/tmp/protection.prop", "browser") == "0"
	then
		ui_print("	-> Force install: Chrome");
		package_extract_dir("system/app/Chrome", "/system/app/Chrome");
	endif;
endif;

if
	file_getprop("/tmp/aroma/gapps.prop", "item.1.7") == "0"
then
	if
		file_getprop("/tmp/protection.prop", "mms") == "0"
	then
		ui_print("	-> Force install: Messenger");
		package_extract_dir("system/app/Messenger", "/system/app/Messenger");
	endif;
endif;

if
	file_getprop("/tmp/aroma/gapps.prop", "item.1.10") == "0"
then
	if
		file_getprop("/tmp/protection.prop", "picotts") == "0"
	then
		ui_print("	-> Force install: GoogleTTS");
		package_extract_dir("system/app/GoogleTTS", "/system/app/GoogleTTS");
		package_extract_dir("system/tts", "/system/tts");
	endif;
endif;

if
	file_getprop("/tmp/aroma/gapps.prop", "item.1.14") == "0"
then
	if
		file_getprop("/tmp/protection.prop", "calendar") == "0"
	then
		ui_print("	-> Force install: Google Calendar");
		package_extract_dir("system/app/CalendarGoogle", "/system/app/CalendarGoogle");
	endif;
endif;

if
	file_getprop("/tmp/aroma/gapps.prop", "item.1.11") == "0"
then
	if
		file_getprop("/tmp/protection.prop", "latinime") == "0"
	then
		ui_print("	-> Force install: Google Keyboard");
		package_extract_dir("system/app/Keyboard", "/system/app/Keyboard");
		package_extract_dir("system/usr/srec/en-US", "/system/usr/srec/en-US");
	endif;
endif;
delete("/tmp/protection.sh", "/tmp/protection.prop");
endif;

set_progress(0.9);
ui_print("-> Cleaning up and setting metadata...");
set_metadata_recursive("/system/addon.d", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0755, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata_recursive("/system/app", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0644, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata_recursive("/system/priv-app", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0644, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata_recursive("/system/etc/permissions", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0755, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata_recursive("/system/etc/preferred-apps", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0755, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata("/system/etc/g.prop", "uid", 0, "gid", 0, "mode", 0755, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata_recursive("/system/framework", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0644, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata_recursive("/system/lib", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0644, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata_recursive("/system/usr/srec/en-US", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0644, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");
set_metadata_recursive("/system/vendor/pittpatt", "uid", 0, "gid", 0, "dmode", 0755, "fmode", 0644, "capabilities", 0x0, "selabel", "u:object_r:system_file:s0");

ui_print(" ");
ui_print("-> Unmounting system...");
run_program("/sbin/busybox", "umount", "/system");

set_progress(1);
ui_print(" ");
ui_print("-> GApps successfully installed!");
